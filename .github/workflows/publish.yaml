name: Python package
on:
  push:
    tags:
      - 'v*.*.*'
    paths:
      - ".github/workflows/publish.yaml" # for testing
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    
    - uses: actions/checkout@v6

    - name: Install Poetry
      uses: Gr1N/setup-poetry@v8
    
    - name: Install dependencies
      run: |
        poetry config virtualenvs.in-project true

    - name: Build package
      run: |
        poetry build

    - name: Check package
      run: |
        # Check that _version.py is in the wheel
        echo "Checking wheel for _version.py..."
        WHEEL_FILE=$(ls dist/*.whl)
        unzip -l "$WHEEL_FILE" | grep "neighpy/_version.py" || (echo "_version.py not found in wheel" && exit 1)
        
        # Check that _version.py is in the source distribution
        echo "Checking sdist for _version.py..."
        SDIST_FILE=$(ls dist/*.tar.gz)
        tar -tzf "$SDIST_FILE" | grep "neighpy/_version.py" || (echo "_version.py not found in sdist" && exit 1)
        
        # Test installation and import from wheel
        source .venv/bin/activate
        pip uninstall -y neighpy
        pip install "$WHEEL_FILE"
        python -c "import neighpy; print(neighpy.__version__)"
        
        # Test installation and import from sdist
        pip uninstall -y neighpy
        pip install "$SDIST_FILE"
        python -c "import neighpy; print(neighpy.__version__)"

    - name: Publish package
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags')
      run: |
        poetry config pypi-token.pypi ${{ secrets.PYPI_TOKEN }}
        poetry publish